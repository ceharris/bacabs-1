# Build the frontend
FROM node:7.9 AS node-frontend-build
WORKDIR /app
COPY ./dashboard/package.json /app
RUN npm install
COPY ./dashboard /app/
COPY ./shared /shared
RUN npm run ng build --prod


# Build the backend
FROM node:7.9 AS node-backend-build
EXPOSE 3000
WORKDIR /app
COPY ./dashboard-backend/package.json /app
RUN npm install
COPY ./dashboard-backend /app/
COPY ./shared /shared
RUN npm run build


FROM node:7.9-alpine
EXPOSE 3000
WORKDIR /app
COPY --from=node-frontend-build /app/package.json /app
RUN npm install --production
COPY --from=node-frontend-build /shared /shared
COPY --from=node-backend-build /app/dist/app/src /app/server
COPY --from=node-frontend-build /app/dist/ /app/dist
CMD node /app/server/index.js

